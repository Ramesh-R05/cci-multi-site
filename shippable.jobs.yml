# This jobs are only used for MULTISITE

####################################################################
# Refer to http://docs.shippable.com/reference/jobs-overview/      #
# Resources are located in shippable.resources.yml file            #
# Jobs are numbered to visualize sequence                          #
####################################################################

jobs:

  # 1. Sync pipeline to CI
  - name: multi-site_runCI
    type: runCI
    steps:
      - OUT: gt-site-img-master
      - OUT: gt-site-img-branch
      - OUT: cosmo-site-img-master
      - OUT: cosmo-site-img-branch
      - OUT: elle-site-img-master
      - OUT: elle-site-img-branch
      - OUT: hb-site-img-master
      - OUT: hb-site-img-branch
      - OUT: awwfood-site-img-master
      - OUT: awwfood-site-img-branch
#      - OUT: foodnz-site-img-master
#      - OUT: foodnz-site-img-branch

  # 2branchAWWFOOD. Manifest for a BRANCH image
  - name: awwfood-site-man-branch
    type: manifest
    steps:
      - IN: awwfood-site-img-branch
      - IN: awwfood-site-opts-sit
      - TASK: managed

  # 2AWWFOOD. Manifest for MASTER image
  - name: awwfood-site-man-master
    type: manifest
    steps:
      - IN: awwfood-site-img-master
      - IN: awwfood-site-opts-sit
      - TASK: managed

#  # 2branchFOODNZ. Manifest for a BRANCH image
#  - name: foodnz-site-man-branch
#    type: manifest
#    steps:
#      - IN: foodnz-site-img-branch
#      - IN: foodnz-site-opts-sit
#      - TASK: managed
#
#  # 2FOODNZ. Manifest for MASTER image
#  - name: foodnz-site-man-master
#    type: manifest
#    steps:
#      - IN: foodnz-site-img-master
#      - IN: foodnz-site-opts-sit
#      - TASK: managed

  # 2branchGT. Manifest for a BRANCH image
  - name: gt-site-man-branch
    type: manifest
    steps:
      - IN: gt-site-img-branch
      - IN: gt-site-opts-sit
      - TASK: managed

  # 2GT. Manifest for MASTER image
  - name: gt-site-man-master
    type: manifest
    steps:
      - IN: gt-site-img-master
      - IN: gt-site-opts-sit
      - TASK: managed

  # 2branchCOSMO. Manifest for a BRANCH image
  - name: cosmo-site-man-branch
    type: manifest
    steps:
      - IN: cosmo-site-img-branch
      - IN: cosmo-site-opts-sit
      - TASK: managed

  # 2COSMO. Manifest for MASTER image
  - name: cosmo-site-man-master
    type: manifest
    steps:
      - IN: cosmo-site-img-master
      - IN: cosmo-site-opts-sit
      - TASK: managed

  # 2branchELLE. Manifest for a BRANCH image
  - name: elle-site-man-branch
    type: manifest
    steps:
      - IN: elle-site-img-branch
      - IN: elle-site-opts-sit
      - TASK: managed

  # 2ELLE. Manifest for MASTER image
  - name: elle-site-man-master
    type: manifest
    steps:
      - IN: elle-site-img-master
      - IN: elle-site-opts-sit
      - TASK: managed

  # 2branchHB. Manifest for a BRANCH image
  - name: hb-site-man-branch
    type: manifest
    steps:
      - IN: hb-site-img-branch
      - IN: hb-site-opts-sit
      - TASK: managed

  # 2HB. Manifest for MASTER image
  - name: hb-site-man-master
    type: manifest
    steps:
      - IN: hb-site-img-master
      - IN: hb-site-opts-sit
      - TASK: managed

  # 3a. TEST deployment for MASTER - stubbed and hb config
  - name: multi-site-test-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: elle-site-man-master
        switch: on
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-test
      - IN: multi-site-alb-test
        applyTo:
          - manifest: elle-site-man-master
            image: elle-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3BranchCOSMO. SIT deployment for feature BRANCH
  - name: cosmo-site-sit-deploy-branch
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: cosmo-site-man-branch
        switch: off
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: cosmo-site-alb-sit-branch
        applyTo:
          - manifest: cosmo-site-man-branch
            image: cosmo-site-img-branch
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3COSMO. SIT deployment for MASTER
  - name: cosmo-site-sit-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: cosmo-site-man-master # for master - auto deploy to SIT
        switch: on
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: cosmo-site-alb-sit
        applyTo:
          - manifest: cosmo-site-man-master
            image: cosmo-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3BranchELLE. SIT deployment for feature BRANCH
  - name: elle-site-sit-deploy-branch
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: elle-site-man-branch
        switch: off
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: elle-site-alb-sit-branch
        applyTo:
          - manifest: elle-site-man-branch
            image: elle-site-img-branch
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3ELLE. SIT deployment for MASTER
  - name: elle-site-sit-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: elle-site-man-master # for master - auto deploy to SIT
        switch: on
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: elle-site-alb-sit
        applyTo:
          - manifest: elle-site-man-master
            image: elle-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3BranchHB. SIT deployment for feature BRANCH
  - name: hb-site-sit-deploy-branch
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: hb-site-man-branch # for non-master, don't auto deploy.
        switch: off
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: hb-site-alb-sit-branch
        applyTo:
          - manifest: hb-site-man-branch
            image: hb-site-img-branch
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3HB. SIT deployment for MASTER
  - name: hb-site-sit-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: hb-site-man-master # for master - auto deploy to SIT
        switch: on
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: hb-site-alb-sit
        applyTo:
          - manifest: hb-site-man-master
            image: hb-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3BranchGT. SIT deployment for feature BRANCH
  - name: gt-site-sit-deploy-branch
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: gt-site-man-branch # for non-master, don't auto deploy.
        switch: off
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: gt-site-alb-sit-branch
        applyTo:
          - manifest: gt-site-man-branch
            image: gt-site-img-branch
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3GT. SIT deployment for MASTER
  - name: gt-site-sit-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: gt-site-man-master # for master - auto deploy to SIT
        switch: on
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: gt-site-alb-sit
        applyTo:
          - manifest: gt-site-man-master
            image: gt-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3BranchAWWFOOD. SIT deployment for feature BRANCH
  - name: awwfood-site-sit-deploy-branch
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: awwfood-site-man-branch # for non-master, don't auto deploy.
        switch: off
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: awwfood-site-alb-sit-branch
        applyTo:
          - manifest: awwfood-site-man-branch
            image: awwfood-site-img-branch
            port: 3001
      - TASK: managed
        deployMethod: replace

  # 3AWWFOOD. SIT deployment for MASTER
  - name: awwfood-site-sit-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
    steps:
      - IN: awwfood-site-man-master # for master - auto deploy to SIT
        switch: on
      - IN: multi-env-sit-ecs
      - IN: multi-site-params-sit
      - IN: awwfood-site-alb-sit
        applyTo:
          - manifest: awwfood-site-man-master
            image: awwfood-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: replace

#  # 3BranchFOODNZ. SIT deployment for feature BRANCH
#  - name: foodnz-site-sit-deploy-branch
#    type: deploy
#    always:
#      - NOTIFY: multi-slack-notifications
#    steps:
#      - IN: foodnz-site-man-branch # for non-master, don't auto deploy.
#        switch: off
#      - IN: multi-env-sit-ecs
#      - IN: multi-site-params-sit
#      - IN: foodnz-site-alb-sit-branch
#        applyTo:
#          - manifest: foodnz-site-man-branch
#            image: foodnz-site-img-branch
#            port: 3001
#      - TASK: managed
#        deployMethod: replace
#
#  # 3FOODNZ. SIT deployment for MASTER
#  - name: foodnz-site-sit-deploy-master
#    type: deploy
#    always:
#      - NOTIFY: multi-slack-notifications
#    steps:
#      - IN: foodnz-site-man-master # for master - auto deploy to SIT
#        switch: on
#      - IN: multi-env-sit-ecs
#      - IN: multi-site-params-sit
#      - IN: foodnz-site-alb-sit
#        applyTo:
#          - manifest: foodnz-site-man-master
#            image: foodnz-site-img-master
#            port: 3001
#      - TASK: managed
#        deployMethod: replace


  # 4a. Run regression test on TEST environment
  - name: multi-site-automation-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: multi-site-test-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=elle-site
       - script: export URL=http://multi-site.test.bxm.net.au/
       - script: npm run test:high || true
       - script: actualsize=$(wc -c <"@rerun.txt")
       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
    on_failure:
      - NOTIFY: elle-deployment-notifications

  # 4b. Run compatibility regression test on TEST environment - Browser Stack
  - name: compatibility-multi-site-automation-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: multi-site-test-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=elle-site
       - script: rm -rf node_modules/chimp/dist/lib/cucumberjs/hooks.js
       - script: cp features/support/files/chimp_hooks.backup node_modules/chimp/dist/lib/cucumberjs/hooks.js
       - script: export URL=http://multi-site.test.bxm.net.au/
       - script: npm run test:mobile
       - script: npm run test:desktop
#    on_failure:
#      - NOTIFY: elle-deployment-notifications

  # 4cCOSMO. Run smoke test on SIT environment COSMO
  - name: cosmo-site-smoke-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: cosmo-site-sit-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=cosmo-site
       - script: export URL=https://www.sit.cosmopolitan.com.au/
       - script: npm run smoketest:cosmo || true
       - script: actualsize=$(wc -c <"@rerun.txt")
       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
    on_failure:
      - NOTIFY: cosmo-deployment-notifications

  # 4cELLE. Run smoke test on SIT environment ELLE
  - name: elle-site-smoke-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: elle-site-sit-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=elle-site
       - script: export URL=https://www.sit.elle.com.au/
       - script: npm run smoketest:elle || true
       - script: actualsize=$(wc -c <"@rerun.txt")
       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
    on_failure:
      - NOTIFY: elle-deployment-notifications

  # 4cHB. Run smoke test on SIT environment HB
  - name: hb-site-smoke-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: hb-site-sit-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=hb-site
       - script: export URL=https://www.sit.harpersbazaar.com.au/
       - script: npm run smoketest:hb || true
       - script: actualsize=$(wc -c <"@rerun.txt")
       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
    on_failure:
      - NOTIFY: hb-deployment-notifications

  # 4cGT. Run smoke test on SIT environment GT
  - name: gt-site-smoke-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: gt-site-sit-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=gt-site
       - script: export URL=https://www.sit.gourmettraveller.com.au/
       - script: npm run smoketest:gt || true
       - script: actualsize=$(wc -c <"@rerun.txt")
       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
    on_failure:
      - NOTIFY: gt-deployment-notifications

  # 4cAWWFOOD. Run smoke test on SIT environment AWWFOOD
  - name: awwfood-site-smoke-test
    type: runSh
    always:
    - NOTIFY: multi-slack-notifications
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: awwfood-site-sit-deploy-master
    - IN: multi-site-repo
      switch: off
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=awwfood-site
       - script: export URL=http://awwfood-site-au.sit.bxm.net.au/
       - script: npm run smoketest:awwfood || true
       - script: actualsize=$(wc -c <"@rerun.txt")
       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
    on_failure:
      - NOTIFY: awwfood-deployment-notifications

#  # 4cFOODNZ. Run smoke test on SIT environment FOODNZ
#  - name: foodnz-site-smoke-test
#    type: runSh
#    always:
#    - NOTIFY: multi-slack-notifications
#    - NOTIFY: multi-qa-team-notifications
#    steps:
#    - IN: foodnz-site-sit-deploy-master
#    - IN: multi-site-repo
#      switch: off
#    - TASK:
#       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
#       - script: source ~/.nvm/nvm.sh
#       - script: nvm install "8.9.1"
#       - script: nvm use "8.9.1"
#       - script: cd ./IN/multi-site-repo/gitRepo/automation
#       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
#       - script: npm install
#       - script: export APP_KEY=foodnz-site
#       - script: export URL=http://foodnz-site-nz.sit.bxm.net.au/
#       - script: npm run smoketest:foodnz || true
#       - script: actualsize=$(wc -c <"@rerun.txt")
#       - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"
#    on_failure:
#      - NOTIFY: foodnz-deployment-notifications

  # 4d. Run performance test on test environment
  - name: multi-site-performance-test
    type: runSh
    steps:
      - IN: multi-site-test-deploy-master
      - IN: test-result-s3-param-multi
      - IN: multi-site-repo
        switch: off
      - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/src
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        - script: sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        - script: sudo apt-get update
        - script: sudo apt-get install google-chrome-stable
        - script: google-chrome --product-version
        - script: npm run test:perf > result.txt
    on_success:
      - script: echo "SUCCESS"
    on_failure:
      - script: echo "FAILURE"
    always:
      script:
        - *template-lighthouse-csv-report
      NOTIFY: multi-slack-notifications

  # 5COSMO. Package release for production release
  - name: cosmo-release-master
    type: release
    dependencyMode: strict
    always:
    - NOTIFY: multi-slack-notifications
    steps:
      - IN: multi-site-automation-test
      - IN: cosmo-site-smoke-test
      - IN: cosmo-site-version
      - IN: cosmo-site-man-master
        switch: off
      - TASK: managed
    on_success:
      - NOTIFY: cosmo-deployment-notifications

  # 5ELLE. Package release for production release
  - name: elle-release-master
    type: release
    dependencyMode: strict
    always:
    - NOTIFY: multi-slack-notifications
    steps:
      - IN: multi-site-automation-test
      - IN: elle-site-smoke-test
      - IN: elle-site-version
      - IN: elle-site-man-master
        switch: off
      - TASK: managed
    on_success:
      - NOTIFY: elle-deployment-notifications

  # 5HB. Package release for production release
  - name: hb-release-master
    type: release
    dependencyMode: strict
    always:
    - NOTIFY: multi-slack-notifications
    steps:
      - IN: multi-site-automation-test
      - IN: hb-site-smoke-test
      - IN: hb-site-version
      - IN: hb-site-man-master
        switch: off
      - TASK: managed
    on_success:
      - NOTIFY: hb-deployment-notifications

  # 5GT. Package release for production release
  - name: gt-release-master
    type: release
    dependencyMode: strict
    always:
    - NOTIFY: multi-slack-notifications
    steps:
      - IN: multi-site-automation-test
      - IN: gt-site-smoke-test
      - IN: gt-site-version
      - IN: gt-site-man-master
        switch: off
      - TASK: managed
    on_success:
      - NOTIFY: gt-deployment-notifications

  # 5AWWFOOD. Package release for production release
  - name: awwfood-release-master
    type: release
    dependencyMode: strict
    always:
    - NOTIFY: multi-slack-notifications
    steps:
      - IN: multi-site-automation-test
      - IN: awwfood-site-smoke-test
      - IN: awwfood-site-version
      - IN: awwfood-site-man-master
        switch: off
      - TASK: managed
    on_success:
      - NOTIFY: awwfood-deployment-notifications

#  # 5FOODNZ. Package release for production release
#  - name: foodnz-release-master
#    type: release
#    dependencyMode: strict
#    always:
#    - NOTIFY: multi-slack-notifications
#    steps:
#      - IN: multi-site-automation-test
#      - IN: foodnz-site-smoke-test
#      - IN: foodnz-site-version
#      - IN: foodnz-site-man-master
#        switch: off
#      - TASK: managed
#    on_success:
#      - NOTIFY: foodnz-deployment-notifications

  # 6COSMO. PROD deployment for MASTER COSMO
  - name: cosmo-site-prod-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
      - NOTIFY: cosmo-deployment-notifications
    steps:
      - IN: cosmo-release-master
        switch: off
      - IN: multi-env-prod-ecs
      - IN: multi-site-params-prod
      - IN: cosmo-site-alb-prod
        applyTo:
          - manifest: cosmo-site-man-master
            image: cosmo-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: upgrade

  # 6ELLE. PROD deployment for MASTER ELLE
  - name: elle-site-prod-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
      - NOTIFY: elle-deployment-notifications
    steps:
      - IN: elle-release-master
        switch: off
      - IN: multi-env-prod-ecs
      - IN: multi-site-params-prod
      - IN: elle-site-alb-prod
        applyTo:
          - manifest: elle-site-man-master
            image: elle-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: upgrade

  # 6HB. PROD deployment for MASTER HB
  - name: hb-site-prod-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
      - NOTIFY: hb-deployment-notifications
    steps:
      - IN: hb-release-master
        switch: off
      - IN: multi-env-prod-ecs
      - IN: multi-site-params-prod
      - IN: hb-site-alb-prod
        applyTo:
          - manifest: hb-site-man-master
            image: hb-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: upgrade

  # 6GT. PROD deployment for MASTER GT
  - name: gt-site-prod-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
      - NOTIFY: gt-deployment-notifications
    steps:
      - IN: gt-release-master
        switch: off
      - IN: multi-env-prod-ecs
      - IN: multi-site-params-prod
      - IN: gt-site-alb-prod
        applyTo:
          - manifest: gt-site-man-master
            image: gt-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: upgrade

  # 6AWWFOOD. PROD deployment for MASTER AWWFOOD
  - name: awwfood-site-prod-deploy-master
    type: deploy
    always:
      - NOTIFY: multi-slack-notifications
      - NOTIFY: awwfood-deployment-notifications
    steps:
      - IN: awwfood-release-master
        switch: off
      - IN: multi-env-prod-ecs
      - IN: multi-site-params-prod
      - IN: awwfood-site-alb-prod
        applyTo:
          - manifest: awwfood-site-man-master
            image: awwfood-site-img-master
            port: 3001
      - TASK: managed
        deployMethod: upgrade

#  # 6FOODNZ. PROD deployment for MASTER FOODNZ
#  - name: foodnz-site-prod-deploy-master
#    type: deploy
#    always:
#      - NOTIFY: multi-slack-notifications
#      - NOTIFY: foodnz-deployment-notifications
#    steps:
#      - IN: foodnz-release-master
#        switch: off
#      - IN: multi-env-prod-ecs
#      - IN: multi-site-params-prod
#      - IN: foodnz-site-alb-prod
#        applyTo:
#          - manifest: foodnz-site-man-master
#            image: foodnz-site-img-master
#            port: 3001
#      - TASK: managed
#        deployMethod: upgrade

  ##############################################
  # Schedule jobs - not attached to the pipeline
  ##############################################

  # i. Full regression in TEST Multi
  - name: FULL-multi-site-regression-test
    type: runSh
    always:
      - NOTIFY: multi-qa-team-notifications
    steps:
     - IN: multi-site-repo
       switch: off
     - IN: multi-morning-trigger
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/automation
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: export URL=http://multi-site.test.bxm.net.au/
        - script: export APP_KEY=elle-site
        - script: npm run test:phantom || true
        - script: node rerun.combine.js
        - script: actualsize=$(wc -c <"@rerun.txt")
        - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"

  # ii. Smoke Test in ELLE Dev CMS
  - name: CMS-elle-smoke-test
    type: runSh
    always:
      - NOTIFY: multi-qa-team-notifications
    steps:
     - IN: multi-site-repo
       switch: off
     - IN: elle-weekly-trigger
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/automation
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: export URL=http://cms.dev.elle.wn.bauer-media.net.au/cms/umbraco/
        - script: export APP_KEY=elle-site
        - script: npm run test:cms || true
        - script: actualsize=$(wc -c <"@rerun.txt")
        - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"

  # iii. Smoke Test in HB Dev CMS
  - name: CMS-hb-smoke-test
    type: runSh
    always:
      - NOTIFY: multi-qa-team-notifications
    steps:
     - IN: multi-site-repo
       switch: off
     - IN: hb-weekly-trigger
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/automation
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: export URL=http://cms.dev.hb.wn.bauer-media.net.au/cms/umbraco/
        - script: export APP_KEY=hb-site
        - script: npm run test:cms || true
        - script: actualsize=$(wc -c <"@rerun.txt")
        - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"

  # iv. Smoke Test in Cosmo Dev CMS
  - name: CMS-cosmo-smoke-test
    type: runSh
    always:
      - NOTIFY: multi-qa-team-notifications
    steps:
     - IN: multi-site-repo
       switch: off
     - IN: cosmo-weekly-trigger
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/automation
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: export URL=http://cms.dev.cosmo.wn.bauer-media.net.au/cms/umbraco/
        - script: export APP_KEY=cosmo-site
        - script: npm run test:cms || true
        - script: actualsize=$(wc -c <"@rerun.txt")
        - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"

  # v. Smoke Test in GT Dev CMS
  - name: CMS-gt-smoke-test
    type: runSh
    always:
      - NOTIFY: multi-qa-team-notifications
    steps:
     - IN: multi-site-repo
       switch: off
     - IN: gt-weekly-trigger
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/automation
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: export URL=http://cms.dev.gt.wn.bauer-media.net.au/cms/umbraco/
        - script: export APP_KEY=gt-site
        - script: npm run test:gtcms || true
        - script: actualsize=$(wc -c <"@rerun.txt")
        - script: bash -c "if [ $actualsize -eq 0 ]; then  echo 'rerun exit code' $actualsize; else npm run test:rerun; fi"

  # vii. Run SEO Test on live environment
  - name: gt-site-seo-test-live
    type: runSh
    steps:
     - IN: test-result-s3-param-multi
     - IN: multi-site-repo
       switch: off
     - IN: gt-seo-live-trigger
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/src
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        - script: sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        - script: sudo apt-get update
        - script: sudo apt-get install google-chrome-stable
        - script: google-chrome --product-version
        - script: npm run test:seolive > result.txt
    on_success:
      - script: echo "SUCCESS"
    on_failure:
      - script: echo "FAILURE"
    always:
      script:
        - *template-lighthouse-csv-report
      NOTIFY: multi-qa-team-notifications

##################################################################################
#This is a workaround for homes-site performance test and seo test via lighthouse#
#We will move to homes-site once the lighthouse works on homes-site repository   #
##################################################################################
  # viii. Run Performance Test on test environment (homes-site)
  - name: homes-site-performance-test-workaround
    type: runSh
    steps:
     - IN: test-result-s3-param-multi
     - IN: multi-site-repo
       switch: off
     - IN: homes-perf-test-trigger-workaround
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/src
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        - script: sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        - script: sudo apt-get update
        - script: sudo apt-get install google-chrome-stable
        - script: google-chrome --product-version
        - script: npm run test:homesperf > result.txt
    on_success:
      - script: echo "SUCCESS"
    on_failure:
      - script: echo "FAILURE"
    always:
      script:
        - *template-lighthouse-csv-report
      NOTIFY: multi-qa-team-notifications

  # x. Run SEO Test on live environment (homes-site)
  - name: homes-site-seo-test-live-workaround
    type: runSh
    steps:
     - IN: test-result-s3-param-multi
     - IN: multi-site-repo
       switch: off
     - IN: homes-seo-live-trigger-workaround
     - TASK:
        - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
        - script: source ~/.nvm/nvm.sh
        - script: nvm install "8.9.1"
        - script: nvm use "8.9.1"
        - script: cd ./IN/multi-site-repo/gitRepo/src
        - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
        - script: npm install
        - script: wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        - script: sudo sh -c 'echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        - script: sudo apt-get update
        - script: sudo apt-get install google-chrome-stable
        - script: google-chrome --product-version
        - script: npm run test:homesseolive > result.txt
    on_success:
      - script: echo "SUCCESS"
    on_failure:
      - script: echo "FAILURE"
    always:
      script:
        - *template-lighthouse-csv-report
      NOTIFY: multi-qa-team-notifications

  # xi. Run compatibility test for AWWFOOD - SPIKE
  - name: awwfood-compatibility-test
    type: runSh
    always:
    - NOTIFY: multi-qa-team-notifications
    steps:
    - IN: multi-site-repo
      switch: off
    - IN: awwfood-weekly-trigger
    - TASK:
       - script: curl https://raw.githubusercontent.com/creationix/nvm/v0.32.1/install.sh | bash
       - script: source ~/.nvm/nvm.sh
       - script: nvm install "8.9.1"
       - script: nvm use "8.9.1"
       - script: cd ./IN/multi-site-repo/gitRepo/automation
       - script: npm set @bxm:registry http://npm.digital.bauer-media.net.au
       - script: npm install
       - script: export APP_KEY=awwfood-site
       - script: rm -rf node_modules/chimp/dist/lib/cucumberjs/hooks.js
       - script: cp features/support/files/chimp_hooks.backup node_modules/chimp/dist/lib/cucumberjs/hooks.js
       - script: export URL=http://awwfood-site-au.sit.bxm.net.au/
       - script: npm run test:awwfoodmobile || mobileResult=failed
       - script: echo $mobileResult
       - script: npm run test:awwfooddesktop || desktopResult=failed
       - script: echo $desktopResult
       - script: npm run test:awwfoodtabletportrait || tabletportraitResult=failed
       - script: echo $tabletportraitResult
       - script: npm run test:awwfoodtabletlandscape || tabletlandscapeResult=failed
       - script: echo $tabletlandscapeResult
       - script: if [ -n "$mobileResult"] || [-n "$desktopResult"] || [-n "$tabletportraitResult"] || [-n "$tabletlandscapeResult"]; then fail; fi