# language setting
build_environment: Ubuntu 12.04
language: node_js
node_js: "6.1.0"

env:
  global:
    - XUNIT_FILE=$SHIPPABLE_BUILD_DIR/shippable/testresults/result.xml # location to store test results
    - BRANCH_NAME="$(sed 's/\//-/g' <<< $BRANCH).$BUILD_NUMBER" # need to replace '/' in the branch name with '-'
  matrix:
    - IMAGE=317367993082.dkr.ecr.ap-southeast-2.amazonaws.com/elle-site
      APP_KEY=elle-site
    - IMAGE=317367993082.dkr.ecr.ap-southeast-2.amazonaws.com/hb-site
      APP_KEY=hb-site
    - IMAGE=317367993082.dkr.ecr.ap-southeast-2.amazonaws.com/cosmo-site
      APP_KEY=cosmo-site
build:
  cache: true
  cache_dir_list:
    - $SHIPPABLE_BUILD_DIR/src/node_modules
  ci:
    - npm set registry http://npm.digital.bauer-media.net.au
    - node --version
    - mkdir -p ./shippable/testresults ./shippable/codecoverage ./shippable/buildoutput
    - cd src
    - npm install
    - echo "module.exports={buildNumber:'$BRANCH_NAME'};" > version.js
    - cat version.js
    - npm run test:ci
    - ./node_modules/.bin/babel-istanbul report cobertura --dir  ..//shippable/codecoverage/
    - NODE_ENV=production npm run build
    - cd ..
    - if [ $IS_PULL_REQUEST == false ]; then docker build --build-arg APP_KEY=$APP_KEY -f Dockerfile.ecs -t $IMAGE:$BRANCH_NAME .; fi
    - if [ $IS_PULL_REQUEST == false ]; then docker tag $IMAGE:$BRANCH_NAME $IMAGE:latest; fi
    - if [ "$BRANCH" == "master" ] && [ $IS_PULL_REQUEST == false ]; then echo "versionName=$BRANCH_NAME" >> $JOB_STATE/$APP_KEY-img-master.env; fi
    - if [ "$BRANCH" != "master" ]; then echo "versionName=$BRANCH_NAME" >> $JOB_STATE/$APP_KEY-img-branch.env; fi
  push:
    - if [ $IS_PULL_REQUEST == false ]; then docker push $IMAGE:$BRANCH_NAME; fi
    - if [ $IS_PULL_REQUEST == false ]; then docker push $IMAGE:latest; fi
    - if [ $IS_PULL_REQUEST == false ]; then docker rmi $IMAGE:$BRANCH_NAME; fi # Clear all docker images after completion
    - if [ $IS_PULL_REQUEST == false ]; then docker rmi $IMAGE:latest; fi # Clear all docker images after completion
branches:
  only:
    - master
    - feature/*
    - fix/*

#Integration and Notifications
integrations:
  hub:
    - integrationName: AWS-digital-services-ECR
      type: ecr
      region: ap-southeast-2

  notifications:
    - integrationName: slack-bauerxcelmedia
      type: slack
      recipients:
        - "au-shippable"
      branches:
        only:
          - master
          - feature/*
          - fix/*
      on_success: always
      on_failure: always
